# EC2接続トラブルシューティング

**日時**: 2025-08-10 16:30 JST  
**症状**: `ssh: connect to host 35.76.100.207 port 22: Connection timed out`

## 🔍 診断結果

### ✅ 問題なし
- SSHキーファイル: 存在、権限400（適切）
- Elastic IP: 35.76.100.207 有効

### ❌ 問題箇所
- **ポート22**: 接続タイムアウト（セキュリティグループ未開放）
- **pingレスポンス**: 応答なし

## 🎯 原因特定（優先度順）

### 🔴 最も可能性が高い原因

#### 1. セキュリティグループ設定不備
```
現状: SSH(22)ポートが開放されていない
対処: AWSコンソール → EC2 → セキュリティグループ → インバウンドルール編集
```

**確認手順**:
1. AWSコンソール → EC2ダッシュボード
2. インスタンス → hokka-beaver-quiz選択
3. セキュリティタブ → セキュリティグループ名クリック
4. インバウンドルール確認

**必要な設定**:
| タイプ | プロトコル | ポート | ソース | 説明 |
|--------|-----------|--------|--------|------|
| SSH | TCP | 22 | マイIP | 管理者アクセス用 |

#### 2. EC2インスタンス状態
```
現状: インスタンス停止の可能性
対処: AWSコンソールでインスタンス状態確認・起動
```

**確認手順**:
1. EC2ダッシュボード → インスタンス
2. hokka-beaver-quiz の状態列確認
3. 状態が「stopped」の場合：右クリック → インスタンスを開始

### 🟡 その他の可能性

#### 3. Elastic IP関連付け問題
```
確認項目: EIPが正しくEC2にアタッチされているか
確認場所: EC2 → Elastic IP → 関連付けられたインスタンス
```

#### 4. VPCネットワークACL
```
確認項目: VPCレベルでの通信制限
確認場所: VPC → ネットワークACL → インバウンドルール
```

## 🛠️ 対処手順（ステップバイステップ）

### Step 1: セキュリティグループ修正（最優先）

1. **AWSコンソールログイン**
   ```
   https://console.aws.amazon.com/ec2/
   ```

2. **セキュリティグループ確認**
   ```
   EC2 → インスタンス → hokka-beaver-quiz → セキュリティタブ
   ```

3. **インバウンドルール編集**
   ```
   セキュリティグループクリック → インバウンドルール → 編集
   ```

4. **SSH規則追加**
   ```
   タイプ: SSH
   プロトコル: TCP
   ポート: 22
   ソース: マイIP（自動検出）
   説明: Admin SSH Access
   ```

### Step 2: インスタンス状態確認

1. **インスタンス一覧確認**
   ```
   EC2 → インスタンス → 状態列確認
   ```

2. **停止時の対処**
   ```
   インスタンス右クリック → インスタンス状態 → 開始
   ```

### Step 3: 接続テスト

修正後、以下のコマンドで接続確認：

```bash
ssh -o ConnectTimeout=10 -i /home/masat/hokka-beaver-quiz-key.pem ec2-user@35.76.100.207
```

## 📋 確認チェックリスト

### セキュリティグループ確認
- [ ] SSH(22)ポート開放済み
- [ ] HTTP(80)ポート開放済み
- [ ] HTTPS(443)ポート開放準備
- [ ] ソースIP設定適切

### インスタンス確認  
- [ ] インスタンス状態: running
- [ ] Elastic IP関連付け: 35.76.100.207
- [ ] VPC: vpc-hokka-beaver-quiz
- [ ] サブネット: public-1a

### ネットワーク確認
- [ ] VPCルートテーブル適切
- [ ] インターネットゲートウェイ接続
- [ ] ネットワークACL制限なし

## 🚀 修正完了後の実行予定

修正が完了したら、以下のスクリプトで自動セットアップ：

```bash
# 転送とセットアップ実行
cd /home/masat/beaver_hokka_quiz/
./transfer_files.sh
```

このスクリプトが実行する内容：
1. SSH接続テスト
2. 必要ファイル転送（.env、RDSテストスクリプト）
3. EC2環境セットアップ
4. RDS接続テスト実行

## 💡 よくある間違い

1. **ソースIP設定ミス**
   - ❌ 0.0.0.0/0 （セキュリティリスク）
   - ✅ マイIP/32 （推奨）

2. **ポート番号間違い**
   - ❌ 80, 443 （HTTP/HTTPS用）
   - ✅ 22 （SSH用）

3. **プロトコル間違い**
   - ❌ UDP
   - ✅ TCP

---

**次のアクション**: AWSコンソールでセキュリティグループ設定を確認・修正してください。