# ビーバーほっかクイズ技術仕様書

*📅 最終更新: 2025-08-10 | バージョン: 4.0.0*

**⚠️ 重要**: このプロジェクトは **hokka-beaver-quiz** です。QuestEdとは完全に別のプロジェクトです。

## 📋 プロジェクト概要

### 基本情報
- **プロジェクト名**: ビーバーほっかクイズ (hokka-beaver-quiz)
- **目的**: 中学校文化祭でのクイズラリーアプリケーション
- **対象**: 中学生および来場者（小学生〜大人）
- **開発言語**: JavaScript (Node.js)
- **データベース**: インメモリデータベース + JSON永続化（RDS準備中）

### プロジェクトの特徴
- 北陸製菓の「ビーバーおかき」をテーマにした教育的クイズ
- 紙の問題とアプリ回答を組み合わせたハイブリッド方式
- 200名同時接続対応の高性能設計
- **モジュラーアーキテクチャ**: Phase 1 & 2 完了

## 🏗️ アーキテクチャ（2025-08-10更新）

### モジュール構成（Phase 1 & 2 完了）

```
hokka-beaver-quiz/
├── enhanced_server.js      # メインサーバー（413行）
│   └── 16個のAPIエンドポイント処理
├── database.js            # データベース管理モジュール（609行）
│   ├── インメモリデータベース（Map構造）
│   ├── JSON永続化機能
│   ├── ユーザー認証・管理
│   ├── クイズ進行管理
│   └── CSV出力機能
├── utils.js               # ユーティリティ関数（127行）
│   ├── MIMEタイプ処理
│   ├── CORS設定
│   ├── エラー処理統一
│   └── レスポンス処理統一
└── その他のファイル...
```

### データ永続化方式
```javascript
// インメモリ + JSON永続化
const Database = {
  users: new Map(),           // ユーザー管理
  questions: new Map(),       // 問題管理
  userAnswers: new Map(),     // 回答管理
  rankings: new Map(),        // ランキング管理
  quizCompletions: new Map(), // 完了状況
  saveToFile(),              // JSON保存
  loadFromFile()             // JSON読み込み
}
```

## 🔗 接続・アクセス方法（非エンジニア向け）

### 1. GitHub接続方法

**リポジトリURL**: https://github.com/QuestEd-masato/hokka-beaver-quiz.git

**注意**: QuestEd-BaseBuilderとは完全に別のリポジトリです！

#### コードのダウンロード方法
```bash
# 1. GitHubからダウンロード（開発者向け）
git clone https://github.com/QuestEd-masato/hokka-beaver-quiz.git

# 2. ブラウザでダウンロード（一般向け）
# GitHubページで緑色の「Code」ボタン → 「Download ZIP」をクリック
```

### 2. EC2接続方法

**⚠️ 重要**: このEC2はhokka-beaver-quiz専用です。QuestEdのEC2とは別です。

#### 接続情報
```bash
# EC2接続コマンド
ssh -i ~/hokka-beaver-quiz-key.pem ec2-user@18.181.244.62

# ファイル転送
scp -i ~/hokka-beaver-quiz-key.pem [ローカルファイル] ec2-user@18.181.244.62:[送信先]

# PEMキー場所（WSL環境）
/home/masat/hokka-beaver-quiz-key.pem
```

#### EC2上でのアプリケーション管理
```bash
# PM2でのアプリケーション管理
pm2 status           # アプリの状況確認
pm2 logs hokka-quiz  # ログ確認
pm2 restart hokka-quiz  # アプリ再起動
pm2 stop hokka-quiz     # アプリ停止

# Nginx（ウェブサーバー）管理
sudo systemctl status nginx   # Nginx状況確認
sudo systemctl restart nginx  # Nginx再起動
sudo nginx -t                 # Nginx設定確認
```

### 3. 現在のアクセス状況

#### ✅ 動作中のサービス
```
┌─────────────┬──────────────┬────────┬──────────┐
│ サービス名   │ ポート       │ 状況   │ 用途     │
├─────────────┼──────────────┼────────┼──────────┤
│ hokka-quiz  │ 8080        │ ✅動作 │ アプリ本体│
│ nginx       │ 80          │ ✅動作 │ リバース  │
│ PM2         │ -           │ ✅動作 │ プロセス  │
│ certbot     │ -           │ ✅準備 │ SSL証明書 │
└─────────────┴──────────────┴────────┴──────────┘
```

#### 現在のアクセスURL（予定）
```
# セキュリティグループ設定後にアクセス可能
http://18.181.244.62/        # Port 80（Nginx経由）
http://18.181.244.62:8080/   # Port 8080（直接アクセス）
```

## 🚫 まだ接続できていない・設定できていないこと

### 1. 外部インターネットからのアクセス ❌

**問題**: AWSセキュリティグループで必要ポートが開放されていない

**必要な設定**:
- Port 80 (HTTP) の開放
- Port 443 (HTTPS) の開放（将来）
- Port 8080 の開放（オプション）

**設定場所**: AWSコンソール → EC2 → セキュリティグループ

### 2. Route53ドメイン設定 ❌

**制限事項**:
- AWS認証情報なし（IAMロール未設定）
- AWSコンソールでの手動操作が必要
- ドメイン購入はクレジットカード決済が必要

**必要な作業**:
1. Route53でドメイン取得
2. DNSレコード設定（A/CNAMEレコード）
3. Nginxの設定更新

### 3. HTTPS証明書設定 ❌

**準備済み**: Let's Encrypt (Certbot 2.6.0)
**制限**: ドメイン取得後でないと証明書取得不可

**設定予定手順**:
```bash
# ドメイン取得後に実行
sudo certbot --nginx -d your-domain.com
```

### 4. RDSデータベース ❌

**現状**: インメモリデータベース + JSON永続化で動作中
**将来**: RDS MySQL接続予定
**影響**: 現在も完全に動作するため急務ではない

## 📊 現在の構成（非エンジニア向け説明）

### 1. サーバー構成

```
インターネット
    ↓
【AWSセキュリティグループ】← 現在閉鎖中（設定必要）
    ↓
【EC2インスタンス：18.181.244.62】
    ├── Nginx（ポート80） ← リバースプロキシ
    │   └── セキュリティヘッダー追加
    │   └── アクセスログ記録
    └── hokka-quiz（ポート8080） ← Node.jsアプリケーション
        ├── ユーザー管理
        ├── クイズ機能
        ├── ランキング
        └── 管理画面
```

### 2. データの流れ

```
ユーザーのスマホ/PC
    ↓（HTTPリクエスト）
Nginx（ポート80）
    ↓（プロキシ転送）
hokka-quizアプリ（ポート8080）
    ↓（データ処理）
インメモリデータベース
    ↓（定期保存）
JSON永続化ファイル（/data/database.json）
```

### 3. データ内容

**現在保存されているデータ**:
- ユーザー: 3名（admin, test, aaa）
- 問題: 10問（北陸製菓ビーバー関連）
- 回答履歴: 0件
- ランキング: 0件

## 🎯 システムの利点

### 1. 高い可用性
- PM2による自動復旧
- Nginxによる安定したWebサーバー
- インメモリデータベースによる高速処理

### 2. スケーラビリティ
- 200名同時接続対応
- モジュラー設計による拡張性
- 将来のRDS移行準備完了

### 3. 運用しやすさ
- ログ自動記録
- PM2による簡単なプロセス管理
- 自動データバックアップ

## 📝 次のステップ

### 即座に実施可能
1. **セキュリティグループ設定**（AWSコンソール）
   - Port 80, 443の開放
   - HTTPアクセス有効化

### 中期的な改善
1. **ドメイン取得・設定**
2. **HTTPS証明書導入**
3. **RDSデータベース構築**

### 長期的な拡張
1. **CDN導入**（CloudFront）
2. **ロードバランサー設定**
3. **監視・アラート設定**

---

**最終更新**: 2025-08-10
**作成者**: Claude (Anthropic)
**プロジェクト**: hokka-beaver-quiz v4.0.0
**EC2インスタンス**: 18.181.244.62
**GitHub**: https://github.com/QuestEd-masato/hokka-beaver-quiz.git

**⚠️ 再度確認**: このドキュメントはhokka-beaver-quiz専用です。QuestEdプロジェクトとは無関係です。