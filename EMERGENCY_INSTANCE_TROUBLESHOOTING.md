# 🚨 緊急：新インスタンス接続不可問題

**日時**: 2025-08-10 16:45 JST  
**緊急度**: 🔴 高（アプリケーション展開が停止中）

## 📊 現在の状況

### ✅ 正常な項目
- インスタンス状態: **実行中**
- Elastic IP関連付け: **正しく設定済み** (35.76.100.207)
- セキュリティグループ: **SSH・HTTP・HTTPS開放済み**
- VPC・サブネット: **適切に設定**

### ❌ 問題箇所
- **SSH接続**: タイムアウト
- **ping応答**: 100%パケットロス
- **ネットワーク通信**: 完全に不通

## 🔍 考えられる根本原因

### 1. インスタンス内部起動問題 (最も可能性大)
```
症状: 表示上は「実行中」だが、内部で起動失敗
原因: Amazon Linux 2023の初期化エラー、SSHDサービス未起動
確認: インスタンス状態チェック、システムログ
```

### 2. セキュリティグループICMP未許可
```
症状: SSH用ポートは開いているが、ping(ICMP)が制限
原因: ICMPプロトコルが明示的に許可されていない
確認: セキュリティグループのインバウンドルール
```

### 3. ネットワークACL制限
```
症状: VPCレベルでの通信制限
原因: カスタムネットワークACLでの制限
確認: VPCネットワークACL設定
```

## 🛠️ 緊急対処手順

### Step 1: インスタンス状態チェック確認 (最優先)

1. **AWSコンソール** → EC2 → インスタンス
2. **hokka-beaver-quiz** を選択
3. **状態チェック**タブを確認
4. 結果の判定：

#### ケースA: 両方合格
```
システムステータス: 合格
インスタンスステータス: 合格
→ ネットワーク設定問題の可能性
```

#### ケースB: いずれか失敗
```
システムステータス: 失敗 → AWS基盤問題
インスタンスステータス: 失敗 → OS起動問題
→ インスタンス再起動または再作成必要
```

### Step 2: システムログ確認

1. **インスタンス** → **アクション**
2. **モニタリングとトラブルシューティング**
3. **システムログの取得**
4. 確認項目：
   - SSH daemon (sshd) の起動状況
   - ネットワーク設定の完了状況
   - エラーメッセージの有無

### Step 3: セキュリティグループ修正

現在の設定に加えて、ICMP許可を追加：

| タイプ | プロトコル | ポート | ソース | 説明 |
|--------|-----------|--------|--------|------|
| カスタムICMP-IPv4 | ICMP | すべて | 0.0.0.0/0 | Ping許可 |

### Step 4: 応急処置（段階的実行）

#### 4-1. インスタンス再起動
```
インスタンス → 右クリック → インスタンス状態 → 再起動
待機時間: 5分
再テスト: ping, SSH接続
```

#### 4-2. Elastic IP再関連付け
```
EC2 → Elastic IP → 35.76.100.207
アクション → 関連付け解除 → 再関連付け
待機時間: 2-3分
```

#### 4-3. 新インスタンス再作成（最終手段）
```
AMI: al2023-ami-2023.8.20250808.1-kernel-6.1-x86_64
VPC: vpc-hokka-beaver-quiz
サブネット: public-1a
セキュリティグループ: 既存のもの使用
キーペア: hokka-beaver-quiz-key
```

## 📋 トラブルシューティングチェックリスト

### 🔍 AWSコンソール確認項目
- [ ] インスタンス状態チェック結果
- [ ] システムログ内容確認
- [ ] セキュリティグループICMP設定
- [ ] ネットワークACL設定確認
- [ ] VPCルートテーブル確認
- [ ] Elastic IP関連付け状況

### 🔄 実行済み対処
- [ ] インスタンス再起動実行
- [ ] セキュリティグループICMP追加
- [ ] Elastic IP再関連付け
- [ ] 接続テスト実行

## 🚀 問題解決後の即座実行予定

EC2接続が復旧したら、自動セットアップを即座実行：

```bash
cd /home/masat/beaver_hokka_quiz/
./transfer_files.sh
```

実行内容：
1. SSH接続確認
2. 基本パッケージインストール (Node.js, MySQL, PM2)
3. .env・RDSテストスクリプト転送
4. RDS接続テスト実行
5. アプリケーション初期セットアップ

## 💡 予防策（今後）

### インスタンス作成時の注意
1. **起動後15分待機** してから接続テスト
2. **状態チェック合格確認** 後に作業開始
3. **システムログ確認** でエラーなしを確認
4. **ICMP許可** をデフォルトでセキュリティグループに追加

### 監視設定
1. **CloudWatch** でインスタンス状態監視
2. **SNS通知** で状態変化アラート設定

---

**現在のアクション**: AWSコンソールでインスタンス状態チェックを確認し、失敗していれば再起動実行してください。