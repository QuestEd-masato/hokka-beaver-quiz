<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🦫 hokkaクイズラリー - 管理画面</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- ヘッダー -->
    <header class="header">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 style="display: flex; align-items: center;">
                    <img src="/images/beaver-logo.png" alt="ビーバーロゴ" style="height: 50px; margin-right: 15px;">
                    hokkaクイズラリー - 管理画面
                </h1>
                <div>
                    <a href="/mypage" class="btn btn-outline btn-small" style="margin-right: 0.5rem;">🏠 マイページ</a>
                    <button onclick="Auth.logout()" class="btn btn-secondary btn-small">ログアウト</button>
                </div>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="main">
        <div class="container">
            <!-- 管理者確認 -->
            <div id="admin-check" class="card text-center fade-in">
                <div class="card-header">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <img src="/images/beaver.png" alt="ビーバーキャラクター" style="height: 80px;">
                        <h2>🔐 管理者権限が必要です</h2>
                    </div>
                </div>
                <div class="card-body">
                    <p>この画面にアクセスするには管理者としてログインしてください。</p>
                    <a href="/mypage" class="btn btn-primary">マイページへ</a>
                </div>
            </div>

            <!-- 管理画面メイン -->
            <div id="admin-main" style="display: none;">
                <!-- 管理者情報 -->
                <div class="card fade-in">
                    <div class="card-header">
                        <h2>👤 管理者ダッシュボード</h2>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div class="stats-card">
                                <div class="stats-number" id="total-users">0</div>
                                <div class="stats-label">参加者数</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-number" id="completed-quiz">0</div>
                                <div class="stats-label">クイズ完了者</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-number" id="avg-score">0</div>
                                <div class="stats-label">平均スコア</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-number" id="survey-completed">0</div>
                                <div class="stats-label">アンケート回答</div>
                            </div>
                        </div>
                        <div>
                            <strong id="admin-nickname">管理者</strong>さん、お疲れさまです！
                        </div>
                    </div>
                </div>

                <!-- 優先機能セクション -->
                <div class="priority-section">
                    <h2 style="color: var(--primary); margin-bottom: 1rem;">🎯 優先機能</h2>
                    
                    <!-- クイック問題編集 -->
                    <div class="card slide-in" style="animation-delay: 0.1s;">
                        <div class="card-header">
                            <h3>📝 クイック問題編集</h3>
                            <p style="color: var(--gray); font-size: var(--font-size-sm); margin: 0.5rem 0 0 0;">
                                問題の内容と解説を素早く編集
                            </p>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;" id="quick-edit-questions">
                                <!-- 問題一覧がここに表示されます -->
                            </div>
                        </div>
                    </div>

                    <!-- ユーザー作成セクション -->
                    <div class="card slide-in" style="animation-delay: 0.2s;">
                        <div class="card-header">
                            <h3>👥 ユーザー作成</h3>
                            <p style="color: var(--gray); font-size: var(--font-size-sm); margin: 0.5rem 0 0 0;">
                                受付で記入された情報をもとにアカウントを作成
                            </p>
                        </div>
                        <div class="card-body">
                            <form id="create-user-form" style="display: grid; gap: 1rem;">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                    <input type="text" id="new-user-name" class="form-input" 
                                           placeholder="本名（管理用）" required>
                                    <input type="text" id="new-user-nickname" class="form-input" 
                                           placeholder="ニックネーム（ログイン用）" required>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                    <select id="new-user-age" class="form-input" required>
                                        <option value="">年齢層を選択</option>
                                        <option value="preschool">ようちえん・ほいくえん</option>
                                        <option value="elementary">小学生</option>
                                        <option value="junior_high">中学生</option>
                                        <option value="high_school">高校生</option>
                                        <option value="adult">大人</option>
                                    </select>
                                    <select id="new-user-gender" class="form-input" required>
                                        <option value="">性別を選択</option>
                                        <option value="male">男性</option>
                                        <option value="female">女性</option>
                                        <option value="other">その他</option>
                                    </select>
                                </div>
                                <input type="password" id="new-user-password" class="form-input" 
                                       placeholder="パスワード" required>
                                <button type="submit" class="btn btn-success btn-large">
                                    👤 アカウントを作成
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- データ出力セクション -->
                    <div class="card slide-in" style="animation-delay: 0.3s;">
                        <div class="card-header">
                            <h3>📊 データ出力・分析</h3>
                            <p style="color: var(--gray); font-size: var(--font-size-sm); margin: 0.5rem 0 0 0;">
                                CSV形式でデータをダウンロード
                            </p>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                                <div class="export-card">
                                    <h4>📈 参加者成績データ</h4>
                                    <p>ユーザー別の正答率、スコア、回答時間</p>
                                    <button onclick="exportScoreData()" class="btn btn-success">
                                        📥 成績CSV出力
                                    </button>
                                </div>
                                <div class="export-card">
                                    <h4>📝 アンケート結果</h4>
                                    <p>アンケート回答内容と集計結果</p>
                                    <button onclick="exportSurveyData()" class="btn btn-success">
                                        📥 アンケートCSV出力
                                    </button>
                                </div>
                                <div class="export-card">
                                    <h4>🔍 問題別分析</h4>
                                    <p>問題ごとの正答率と選択肢分布</p>
                                    <button onclick="exportQuestionAnalysis()" class="btn btn-success">
                                        📥 問題分析CSV出力
                                    </button>
                                </div>
                                <div class="export-card">
                                    <h4>📋 全データ統合</h4>
                                    <p>すべてのデータを統合したレポート</p>
                                    <button onclick="exportFullReport()" class="btn btn-warning">
                                        📥 統合レポートCSV出力
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 詳細管理セクション -->
                <div class="detailed-section">
                    <h2 style="color: var(--secondary); margin: 2rem 0 1rem 0;">🔧 詳細管理</h2>
                    
                    <!-- アンケート管理 -->
                    <div class="card slide-in" style="animation-delay: 0.3s;">
                        <div class="card-header">
                            <h3>📋 アンケート管理</h3>
                        </div>
                        <div class="card-body">
                            <p style="margin-bottom: 1rem;">アンケートの質問内容やボーナスポイントを編集できます。</p>
                            <a href="/survey" class="btn btn-primary">
                                ✏️ アンケートを編集
                            </a>
                        </div>
                    </div>
                    
                    <!-- 問題管理 -->
                    <div class="card slide-in" style="animation-delay: 0.3s;">
                        <div class="card-header">
                            <h3>📚 問題管理</h3>
                        </div>
                        <div class="card-body">
                            <!-- 新規問題追加 -->
                            <div class="admin-section">
                                <h4>新しい問題を追加</h4>
                                <form id="new-question-form" style="display: grid; gap: 1rem;">
                                    <input type="number" id="new-question-number" class="form-input" 
                                           placeholder="問題番号" min="1" max="20" required>
                                    <input type="text" id="new-question-text" class="form-input" 
                                           placeholder="問題文" required>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                                        <input type="text" id="new-choice-a" class="form-input" placeholder="選択肢A" required>
                                        <input type="text" id="new-choice-b" class="form-input" placeholder="選択肢B" required>
                                        <input type="text" id="new-choice-c" class="form-input" placeholder="選択肢C" required>
                                        <input type="text" id="new-choice-d" class="form-input" placeholder="選択肢D" required>
                                    </div>
                                    <select id="new-correct-answer" class="form-input" required>
                                        <option value="">正解を選択</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                        <option value="D">D</option>
                                    </select>
                                    <textarea id="new-explanation" class="form-input" 
                                              rows="3" placeholder="解説" required></textarea>
                                    <button type="submit" class="btn btn-primary">
                                        ➕ 問題を追加
                                    </button>
                                </form>
                            </div>
                            
                            <!-- 既存問題一覧 -->
                            <div class="admin-section">
                                <h4>既存問題一覧</h4>
                                <div id="questions-list">
                                    <!-- 問題リストがここに表示されます -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- システム統計 -->
                    <div class="card slide-in" style="animation-delay: 0.4s;">
                        <div class="card-header">
                            <h3>📊 システム統計</h3>
                        </div>
                        <div class="card-body">
                            <div id="system-stats">
                                <!-- 統計情報がここに表示されます -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- エラー・成功メッセージ -->
            <div id="error-message" class="alert alert-error" style="display: none;"></div>
            <div id="success-message" class="alert alert-success" style="display: none;"></div>
        </div>
    </main>

    <!-- フッター -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 金沢学院大学附属中学校２年１組 - hokkaクイズラリー</p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="/js/app.js"></script>

    <!-- 管理画面固有のスクリプト -->
    <script>
        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', async () => {
            checkAdminAccess();
        });

        // 管理者アクセス確認
        function checkAdminAccess() {
            if (!Auth.isAuthenticated() || !AppState.currentUser?.is_admin) {
                document.getElementById('admin-check').style.display = 'block';
                document.getElementById('admin-main').style.display = 'none';
                return;
            }

            // 管理者の場合
            document.getElementById('admin-check').style.display = 'none';
            document.getElementById('admin-main').style.display = 'block';
            
            initAdminPanel();
        }

        // 管理パネル初期化
        async function initAdminPanel() {
            const user = AppState.currentUser;
            if (user) {
                Utils.$('#admin-nickname').textContent = user.nickname;
            }

            await Promise.all([
                loadDashboardStats(),
                loadQuickEditQuestions(),
                loadQuestionsList(),
                loadSystemStats()
            ]);

            setupFormHandlers();
        }

        // ダッシュボード統計読み込み
        async function loadDashboardStats() {
            try {
                const [users, rankings] = await Promise.all([
                    Utils.apiCall('/api/debug/users'),
                    Utils.apiCall('/api/ranking')
                ]);

                const totalUsers = users.users?.length || 0;
                const completedQuiz = rankings.rankings?.length || 0;
                const avgScore = completedQuiz > 0 ? 
                    Math.round(rankings.rankings.reduce((sum, r) => sum + r.final_score, 0) / completedQuiz) : 0;
                const surveyCompleted = rankings.rankings?.filter(r => r.survey_bonus > 0).length || 0;

                Utils.$('#total-users').textContent = totalUsers;
                Utils.$('#completed-quiz').textContent = completedQuiz;
                Utils.$('#avg-score').textContent = avgScore + '点';
                Utils.$('#survey-completed').textContent = surveyCompleted;

            } catch (error) {
                console.error('統計読み込みエラー:', error);
            }
        }

        // クイック編集用問題読み込み
        async function loadQuickEditQuestions() {
            try {
                const result = await Utils.apiCall('/api/quiz/questions');
                const questions = result.questions || [];
                const container = Utils.$('#quick-edit-questions');

                const questionsHtml = questions.slice(0, 6).map(q => `
                    <div class="quick-edit-card">
                        <div class="question-preview">
                            <strong>問題${q.question_number}</strong>
                            <p>${q.question_text.substring(0, 50)}...</p>
                            <small>正解: ${q.correct_answer}</small>
                        </div>
                        <div class="quick-actions">
                            <button onclick="quickEditQuestion(${q.id})" class="btn btn-outline btn-small">
                                ✏️ 編集
                            </button>
                            <button onclick="quickEditExplanation(${q.id})" class="btn btn-info btn-small">
                                💬 解説
                            </button>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = questionsHtml;

            } catch (error) {
                console.error('クイック編集読み込みエラー:', error);
            }
        }

        // 問題一覧読み込み
        async function loadQuestionsList() {
            try {
                const result = await Utils.apiCall('/api/quiz/questions');
                const questions = result.questions || [];
                const container = Utils.$('#questions-list');

                const questionsHtml = questions.map(q => `
                    <div class="question-item">
                        <div class="question-header">
                            <strong>問題 ${q.question_number}: ${q.question_text}</strong>
                            <div>
                                <button onclick="editQuestion(${q.id})" class="btn btn-outline btn-small">編集</button>
                                <button onclick="deleteQuestion(${q.id})" class="btn btn-danger btn-small">削除</button>
                            </div>
                        </div>
                        <div class="question-details">
                            <p><strong>選択肢:</strong> A: ${q.choice_a} | B: ${q.choice_b} | C: ${q.choice_c} | D: ${q.choice_d}</p>
                            <p><strong>正解:</strong> ${q.correct_answer}</p>
                            <p><strong>解説:</strong> ${q.explanation}</p>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = questionsHtml;

            } catch (error) {
                console.error('問題一覧読み込みエラー:', error);
            }
        }

        // システム統計読み込み
        async function loadSystemStats() {
            try {
                const container = Utils.$('#system-stats');
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div class="stat-item">
                            <h4>🕐 システム稼働時間</h4>
                            <p>起動時刻: ${new Date().toLocaleString('ja-JP')}</p>
                        </div>
                        <div class="stat-item">
                            <h4>📊 メモリ使用量</h4>
                            <p>メモリベースDB稼働中</p>
                        </div>
                        <div class="stat-item">
                            <h4>🔄 接続状況</h4>
                            <p>最大200名同時接続対応</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('システム統計読み込みエラー:', error);
            }
        }

        // フォームハンドラー設定
        function setupFormHandlers() {
            const newQuestionForm = Utils.$('#new-question-form');
            if (newQuestionForm) {
                newQuestionForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await addNewQuestion();
                });
            }

            const createUserForm = Utils.$('#create-user-form');
            if (createUserForm) {
                createUserForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await createNewUser();
                });
            }
        }

        // 新規ユーザー作成
        async function createNewUser() {
            const userData = {
                real_name: Utils.$('#new-user-name').value,
                nickname: Utils.$('#new-user-nickname').value,
                age_group: Utils.$('#new-user-age').value,
                gender: Utils.$('#new-user-gender').value,
                password: Utils.$('#new-user-password').value
            };

            try {
                const result = await Utils.apiCall('/api/admin/users', {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });

                if (result.success) {
                    Utils.showSuccess(`アカウントを作成しました: ${userData.nickname}`);
                    Utils.$('#create-user-form').reset();
                    await loadDashboardStats(); // 統計を更新
                }
            } catch (error) {
                Utils.showError('アカウントの作成に失敗しました: ' + error.message);
            }
        }

        // 新規問題追加
        async function addNewQuestion() {
            const questionData = {
                question_number: parseInt(Utils.$('#new-question-number').value),
                question_text: Utils.$('#new-question-text').value,
                choice_a: Utils.$('#new-choice-a').value,
                choice_b: Utils.$('#new-choice-b').value,
                choice_c: Utils.$('#new-choice-c').value,
                choice_d: Utils.$('#new-choice-d').value,
                correct_answer: Utils.$('#new-correct-answer').value,
                explanation: Utils.$('#new-explanation').value
            };

            try {
                const result = await Utils.apiCall('/api/admin/questions', {
                    method: 'POST',
                    body: JSON.stringify(questionData)
                });

                if (result.success) {
                    Utils.showSuccess('問題を追加しました');
                    Utils.$('#new-question-form').reset();
                    await loadQuestionsList();
                    await loadQuickEditQuestions();
                }
            } catch (error) {
                Utils.showError('問題の追加に失敗しました: ' + error.message);
            }
        }

        // CSV出力機能
        async function exportScoreData() {
            try {
                const response = await fetch('/api/admin/export/scores');
                if (response.ok) {
                    const blob = await response.blob();
                    downloadCSV(blob, 'quiz_scores.csv');
                } else {
                    Utils.showError('成績データの出力に失敗しました');
                }
            } catch (error) {
                Utils.showError('成績データの出力に失敗しました: ' + error.message);
            }
        }

        async function exportSurveyData() {
            try {
                const response = await fetch('/api/admin/export/survey');
                if (response.ok) {
                    const blob = await response.blob();
                    downloadCSV(blob, 'survey_results.csv');
                } else {
                    Utils.showError('アンケートデータの出力に失敗しました');
                }
            } catch (error) {
                Utils.showError('アンケートデータの出力に失敗しました: ' + error.message);
            }
        }

        async function exportQuestionAnalysis() {
            try {
                const response = await fetch('/api/admin/export/questions');
                if (response.ok) {
                    const blob = await response.blob();
                    downloadCSV(blob, 'question_analysis.csv');
                } else {
                    Utils.showError('問題分析データの出力に失敗しました');
                }
            } catch (error) {
                Utils.showError('問題分析データの出力に失敗しました: ' + error.message);
            }
        }

        async function exportFullReport() {
            try {
                const response = await fetch('/api/admin/export/full');
                if (response.ok) {
                    const blob = await response.blob();
                    downloadCSV(blob, 'full_report.csv');
                } else {
                    Utils.showError('統合レポートの出力に失敗しました');
                }
            } catch (error) {
                Utils.showError('統合レポートの出力に失敗しました: ' + error.message);
            }
        }

        function downloadCSV(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            Utils.showSuccess(`${filename} をダウンロードしました`);
        }

        // その他の機能（簡略版）
        async function quickEditQuestion(questionId) {
            // クイック編集モーダルを表示（実装省略）
            Utils.showSuccess('クイック編集機能（実装中）');
        }

        async function quickEditExplanation(questionId) {
            // 解説編集モーダルを表示（実装省略）
            Utils.showSuccess('解説編集機能（実装中）');
        }

        async function editQuestion(questionId) {
            try {
                // 問題データを取得
                const result = await Utils.apiCall('/api/quiz/questions');
                const question = result.questions.find(q => q.id === questionId);
                
                if (!question) {
                    Utils.showError('問題が見つかりません');
                    return;
                }

                // 編集フォームを表示
                showQuestionEditModal(question);
            } catch (error) {
                Utils.showError('問題の読み込みに失敗しました: ' + error.message);
            }
        }

        // 問題編集モーダル表示
        function showQuestionEditModal(question) {
            const modalHtml = `
                <div id="edit-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                     background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; max-width: 600px; width: 90%; max-height: 90%; overflow-y: auto; 
                         border-radius: var(--border-radius); padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3>問題編集 - 問題${question.question_number}</h3>
                            <button onclick="closeEditModal()" style="border: none; background: none; font-size: 1.5rem; cursor: pointer;">×</button>
                        </div>
                        
                        <form id="edit-question-form">
                            <div style="display: grid; gap: 1rem;">
                                <div>
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">問題文</label>
                                    <textarea id="edit-question-text" style="width: 100%; min-height: 80px; padding: 0.5rem; 
                                              border: 1px solid var(--light-gray); border-radius: var(--border-radius);">${question.question_text}</textarea>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                                    <div>
                                        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">選択肢A</label>
                                        <input type="text" id="edit-choice-a" value="${question.choice_a}" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--light-gray); border-radius: var(--border-radius);">
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">選択肢B</label>
                                        <input type="text" id="edit-choice-b" value="${question.choice_b}" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--light-gray); border-radius: var(--border-radius);">
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">選択肢C</label>
                                        <input type="text" id="edit-choice-c" value="${question.choice_c}" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--light-gray); border-radius: var(--border-radius);">
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">選択肢D</label>
                                        <input type="text" id="edit-choice-d" value="${question.choice_d}" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--light-gray); border-radius: var(--border-radius);">
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">正解</label>
                                    <select id="edit-correct-answer" style="width: 100%; padding: 0.5rem; border: 1px solid var(--light-gray); border-radius: var(--border-radius);">
                                        <option value="A" ${question.correct_answer === 'A' ? 'selected' : ''}>A</option>
                                        <option value="B" ${question.correct_answer === 'B' ? 'selected' : ''}>B</option>
                                        <option value="C" ${question.correct_answer === 'C' ? 'selected' : ''}>C</option>
                                        <option value="D" ${question.correct_answer === 'D' ? 'selected' : ''}>D</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">解説</label>
                                    <textarea id="edit-explanation" style="width: 100%; min-height: 100px; padding: 0.5rem; 
                                              border: 1px solid var(--light-gray); border-radius: var(--border-radius);">${question.explanation}</textarea>
                                </div>
                                
                                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                                    <button type="button" onclick="closeEditModal()" class="btn btn-secondary">キャンセル</button>
                                    <button type="submit" class="btn btn-success">保存</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // フォーム送信イベント
            document.getElementById('edit-question-form').addEventListener('submit', (e) => {
                e.preventDefault();
                saveQuestionEdit(question.id);
            });
        }

        // 編集モーダルを閉じる
        function closeEditModal() {
            const modal = document.getElementById('edit-modal');
            if (modal) {
                modal.remove();
            }
        }

        // 問題編集を保存
        async function saveQuestionEdit(questionId) {
            const updatedData = {
                question_text: document.getElementById('edit-question-text').value,
                choice_a: document.getElementById('edit-choice-a').value,
                choice_b: document.getElementById('edit-choice-b').value,
                choice_c: document.getElementById('edit-choice-c').value,
                choice_d: document.getElementById('edit-choice-d').value,
                correct_answer: document.getElementById('edit-correct-answer').value,
                explanation: document.getElementById('edit-explanation').value
            };

            try {
                const result = await Utils.apiCall(`/api/admin/questions/${questionId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updatedData)
                });

                if (result.success) {
                    Utils.showSuccess('問題を更新しました');
                    closeEditModal();
                    await loadQuestionsList(); // リストを再読み込み
                    await loadQuickEditQuestions(); // クイック編集も更新
                }
            } catch (error) {
                Utils.showError('問題の更新に失敗しました: ' + error.message);
            }
        }

        async function deleteQuestion(questionId) {
            if (!confirm('この問題を削除しますか？')) return;
            
            try {
                const result = await Utils.apiCall(`/api/admin/questions/${questionId}`, {
                    method: 'DELETE'
                });

                if (result.success) {
                    Utils.showSuccess('問題を削除しました');
                    await loadQuestionsList();
                    await loadQuickEditQuestions();
                }
            } catch (error) {
                Utils.showError('問題の削除に失敗しました: ' + error.message);
            }
        }
    </script>

    <!-- 管理画面用追加CSS -->
    <style>
        .priority-section {
            margin-bottom: 3rem;
        }

        .detailed-section {
            margin-top: 2rem;
        }

        .stats-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            text-align: center;
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stats-label {
            font-size: var(--font-size-sm);
            opacity: 0.9;
        }

        .quick-edit-card {
            background: var(--light-gray);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .quick-edit-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .question-preview p {
            color: var(--gray);
            margin: 0.5rem 0;
        }

        .quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .export-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            border: 2px solid var(--light-gray);
            text-align: center;
            transition: all 0.3s ease;
        }

        .export-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .export-card h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .export-card p {
            color: var(--gray);
            margin-bottom: 1rem;
            font-size: var(--font-size-sm);
        }

        .question-item {
            background: var(--white);
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--light-gray);
            border-bottom: 1px solid var(--border-color);
        }

        .question-details {
            padding: 1rem;
        }

        .question-details p {
            margin-bottom: 0.5rem;
            font-size: var(--font-size-sm);
        }

        .admin-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--light-gray);
            border-radius: var(--border-radius);
        }

        .stat-item {
            background: var(--white);
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--light-gray);
        }

        .stat-item h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .alert {
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
        }

        .alert-error {
            background: rgba(220, 20, 60, 0.1);
            color: var(--error);
            border: 1px solid var(--error);
        }

        .alert-success {
            background: rgba(34, 139, 34, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        @media (max-width: 768px) {
            .quick-actions {
                flex-direction: column;
            }
            
            .question-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }
    </style>
</body>
</html>