<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¦« hokkaã‚¯ã‚¤ã‚ºãƒ©ãƒªãƒ¼ - ç®¡ç†ç”»é¢</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 style="display: flex; align-items: center;">
                    <img src="/images/beaver-logo.png" alt="ãƒ“ãƒ¼ãƒãƒ¼ãƒ­ã‚´" style="height: 50px; margin-right: 15px;">
                    hokkaã‚¯ã‚¤ã‚ºãƒ©ãƒªãƒ¼ - ç®¡ç†ç”»é¢
                </h1>
                <div>
                    <a href="/mypage" class="btn btn-outline btn-small" style="margin-right: 0.5rem;">ğŸ  ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
                    <button onclick="Auth.logout()" class="btn btn-secondary btn-small">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main">
        <div class="container">
            <!-- ç®¡ç†è€…ç¢ºèª -->
            <div id="admin-check" class="card text-center fade-in">
                <div class="card-header">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <img src="/images/beaver.png" alt="ãƒ“ãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼" style="height: 80px;">
                        <h2>ğŸ” ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™</h2>
                    </div>
                </div>
                <div class="card-body">
                    <p>ã“ã®ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
                    <a href="/mypage" class="btn btn-primary">ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸</a>
                </div>
            </div>

            <!-- ç®¡ç†ç”»é¢ãƒ¡ã‚¤ãƒ³ -->
            <div id="admin-main" style="display: none;">
                <!-- ç®¡ç†è€…æƒ…å ± -->
                <div class="card fade-in">
                    <div class="card-header">
                        <h2>ğŸ‘¤ ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div class="stats-card">
                                <div class="stats-number" id="total-users">0</div>
                                <div class="stats-label">å‚åŠ è€…æ•°</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-number" id="completed-quiz">0</div>
                                <div class="stats-label">ã‚¯ã‚¤ã‚ºå®Œäº†è€…</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-number" id="avg-score">0</div>
                                <div class="stats-label">å¹³å‡ã‚¹ã‚³ã‚¢</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-number" id="survey-completed">0</div>
                                <div class="stats-label">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”</div>
                            </div>
                        </div>
                        <div>
                            <strong id="admin-nickname">ç®¡ç†è€…</strong>ã•ã‚“ã€ãŠç–²ã‚Œã•ã¾ã§ã™ï¼
                        </div>
                    </div>
                </div>

                <!-- å„ªå…ˆæ©Ÿèƒ½ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="priority-section">
                    <h2 style="color: var(--primary); margin-bottom: 1rem;">ğŸ¯ å„ªå…ˆæ©Ÿèƒ½</h2>
                    
                    <!-- ã‚¯ã‚¤ãƒƒã‚¯å•é¡Œç·¨é›† -->
                    <div class="card slide-in" style="animation-delay: 0.1s;">
                        <div class="card-header">
                            <h3>ğŸ“ ã‚¯ã‚¤ãƒƒã‚¯å•é¡Œç·¨é›†</h3>
                            <p style="color: var(--gray); font-size: var(--font-size-sm); margin: 0.5rem 0 0 0;">
                                å•é¡Œã®å†…å®¹ã¨è§£èª¬ã‚’ç´ æ—©ãç·¨é›†
                            </p>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;" id="quick-edit-questions">
                                <!-- å•é¡Œä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                            </div>
                        </div>
                    </div>

                    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="card slide-in" style="animation-delay: 0.2s;">
                        <div class="card-header">
                            <h3>ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ</h3>
                            <p style="color: var(--gray); font-size: var(--font-size-sm); margin: 0.5rem 0 0 0;">
                                å—ä»˜ã§è¨˜å…¥ã•ã‚ŒãŸæƒ…å ±ã‚’ã‚‚ã¨ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ
                            </p>
                        </div>
                        <div class="card-body">
                            <form id="create-user-form" style="display: grid; gap: 1rem;">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                    <input type="text" id="new-user-name" class="form-input" 
                                           placeholder="æœ¬åï¼ˆç®¡ç†ç”¨ï¼‰" required>
                                    <input type="text" id="new-user-nickname" class="form-input" 
                                           placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ç”¨ï¼‰" required>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                    <select id="new-user-age" class="form-input" required>
                                        <option value="">å¹´é½¢å±¤ã‚’é¸æŠ</option>
                                        <option value="preschool">ã‚ˆã†ã¡ãˆã‚“ãƒ»ã»ã„ããˆã‚“</option>
                                        <option value="elementary">å°å­¦ç”Ÿ</option>
                                        <option value="junior_high">ä¸­å­¦ç”Ÿ</option>
                                        <option value="high_school">é«˜æ ¡ç”Ÿ</option>
                                        <option value="adult">å¤§äºº</option>
                                    </select>
                                    <select id="new-user-gender" class="form-input" required>
                                        <option value="">æ€§åˆ¥ã‚’é¸æŠ</option>
                                        <option value="male">ç”·æ€§</option>
                                        <option value="female">å¥³æ€§</option>
                                        <option value="other">ãã®ä»–</option>
                                    </select>
                                </div>
                                <input type="password" id="new-user-password" class="form-input" 
                                       placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
                                <button type="submit" class="btn btn-success btn-large">
                                    ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="card slide-in" style="animation-delay: 0.3s;">
                        <div class="card-header">
                            <h3>ğŸ“Š ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›ãƒ»åˆ†æ</h3>
                            <p style="color: var(--gray); font-size: var(--font-size-sm); margin: 0.5rem 0 0 0;">
                                CSVå½¢å¼ã§ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </p>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                                <div class="export-card">
                                    <h4>ğŸ“ˆ å‚åŠ è€…æˆç¸¾ãƒ‡ãƒ¼ã‚¿</h4>
                                    <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã®æ­£ç­”ç‡ã€ã‚¹ã‚³ã‚¢ã€å›ç­”æ™‚é–“</p>
                                    <button onclick="exportScoreData()" class="btn btn-success">
                                        ğŸ“¥ æˆç¸¾CSVå‡ºåŠ›
                                    </button>
                                </div>
                                <div class="export-card">
                                    <h4>ğŸ“ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœ</h4>
                                    <p>ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”å†…å®¹ã¨é›†è¨ˆçµæœ</p>
                                    <button onclick="exportSurveyData()" class="btn btn-success">
                                        ğŸ“¥ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆCSVå‡ºåŠ›
                                    </button>
                                </div>
                                <div class="export-card">
                                    <h4>ğŸ” å•é¡Œåˆ¥åˆ†æ</h4>
                                    <p>å•é¡Œã”ã¨ã®æ­£ç­”ç‡ã¨é¸æŠè‚¢åˆ†å¸ƒ</p>
                                    <button onclick="exportQuestionAnalysis()" class="btn btn-success">
                                        ğŸ“¥ å•é¡Œåˆ†æCSVå‡ºåŠ›
                                    </button>
                                </div>
                                <div class="export-card">
                                    <h4>ğŸ“‹ å…¨ãƒ‡ãƒ¼ã‚¿çµ±åˆ</h4>
                                    <p>ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—ãŸãƒ¬ãƒãƒ¼ãƒˆ</p>
                                    <button onclick="exportFullReport()" class="btn btn-warning">
                                        ğŸ“¥ çµ±åˆãƒ¬ãƒãƒ¼ãƒˆCSVå‡ºåŠ›
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è©³ç´°ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="detailed-section">
                    <h2 style="color: var(--secondary); margin: 2rem 0 1rem 0;">ğŸ”§ è©³ç´°ç®¡ç†</h2>
                    
                    <!-- ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç®¡ç† -->
                    <div class="card slide-in" style="animation-delay: 0.3s;">
                        <div class="card-header">
                            <h3>ğŸ“‹ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç®¡ç†</h3>
                        </div>
                        <div class="card-body">
                            <p style="margin-bottom: 1rem;">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®è³ªå•å†…å®¹ã‚„ãƒœãƒ¼ãƒŠã‚¹ãƒã‚¤ãƒ³ãƒˆã‚’ç·¨é›†ã§ãã¾ã™ã€‚</p>
                            <a href="/survey" class="btn btn-primary">
                                âœï¸ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ç·¨é›†
                            </a>
                        </div>
                    </div>
                    
                    <!-- å•é¡Œç®¡ç† -->
                    <div class="card slide-in" style="animation-delay: 0.3s;">
                        <div class="card-header">
                            <h3>ğŸ“š å•é¡Œç®¡ç†</h3>
                        </div>
                        <div class="card-body">
                            <!-- æ–°è¦å•é¡Œè¿½åŠ  -->
                            <div class="admin-section">
                                <h4>æ–°ã—ã„å•é¡Œã‚’è¿½åŠ </h4>
                                <form id="new-question-form" style="display: grid; gap: 1rem;">
                                    <input type="number" id="new-question-number" class="form-input" 
                                           placeholder="å•é¡Œç•ªå·" min="1" max="20" required>
                                    <input type="text" id="new-question-text" class="form-input" 
                                           placeholder="å•é¡Œæ–‡" required>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                                        <input type="text" id="new-choice-a" class="form-input" placeholder="é¸æŠè‚¢A" required>
                                        <input type="text" id="new-choice-b" class="form-input" placeholder="é¸æŠè‚¢B" required>
                                        <input type="text" id="new-choice-c" class="form-input" placeholder="é¸æŠè‚¢C" required>
                                        <input type="text" id="new-choice-d" class="form-input" placeholder="é¸æŠè‚¢D" required>
                                    </div>
                                    <select id="new-correct-answer" class="form-input" required>
                                        <option value="">æ­£è§£ã‚’é¸æŠ</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="C">C</option>
                                        <option value="D">D</option>
                                    </select>
                                    <textarea id="new-explanation" class="form-input" 
                                              rows="3" placeholder="è§£èª¬" required></textarea>
                                    <button type="submit" class="btn btn-primary">
                                        â• å•é¡Œã‚’è¿½åŠ 
                                    </button>
                                </form>
                            </div>
                            
                            <!-- æ—¢å­˜å•é¡Œä¸€è¦§ -->
                            <div class="admin-section">
                                <h4>æ—¢å­˜å•é¡Œä¸€è¦§</h4>
                                <div id="questions-list">
                                    <!-- å•é¡Œãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆ -->
                    <div class="card slide-in" style="animation-delay: 0.4s;">
                        <div class="card-header">
                            <h3>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆ</h3>
                        </div>
                        <div class="card-body">
                            <div id="system-stats">
                                <!-- çµ±è¨ˆæƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ã‚¨ãƒ©ãƒ¼ãƒ»æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div id="error-message" class="alert alert-error" style="display: none;"></div>
            <div id="success-message" class="alert alert-success" style="display: none;"></div>
        </div>
    </main>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 é‡‘æ²¢å­¦é™¢å¤§å­¦é™„å±ä¸­å­¦æ ¡ï¼’å¹´ï¼‘çµ„ - hokkaã‚¯ã‚¤ã‚ºãƒ©ãƒªãƒ¼</p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="/js/app.js"></script>

    <!-- ç®¡ç†ç”»é¢å›ºæœ‰ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            checkAdminAccess();
        });

        // ç®¡ç†è€…ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
        function checkAdminAccess() {
            if (!Auth.isAuthenticated() || !AppState.currentUser?.is_admin) {
                document.getElementById('admin-check').style.display = 'block';
                document.getElementById('admin-main').style.display = 'none';
                return;
            }

            // ç®¡ç†è€…ã®å ´åˆ
            document.getElementById('admin-check').style.display = 'none';
            document.getElementById('admin-main').style.display = 'block';
            
            initAdminPanel();
        }

        // ç®¡ç†ãƒ‘ãƒãƒ«åˆæœŸåŒ–
        async function initAdminPanel() {
            const user = AppState.currentUser;
            if (user) {
                Utils.$('#admin-nickname').textContent = user.nickname;
            }

            await Promise.all([
                loadDashboardStats(),
                loadQuickEditQuestions(),
                loadQuestionsList(),
                loadSystemStats()
            ]);

            setupFormHandlers();
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰çµ±è¨ˆèª­ã¿è¾¼ã¿
        async function loadDashboardStats() {
            try {
                const [users, rankings] = await Promise.all([
                    Utils.apiCall('/api/debug/users'),
                    Utils.apiCall('/api/ranking')
                ]);

                const totalUsers = users.users?.length || 0;
                const completedQuiz = rankings.rankings?.length || 0;
                const avgScore = completedQuiz > 0 ? 
                    Math.round(rankings.rankings.reduce((sum, r) => sum + r.final_score, 0) / completedQuiz) : 0;
                const surveyCompleted = rankings.rankings?.filter(r => r.survey_bonus > 0).length || 0;

                Utils.$('#total-users').textContent = totalUsers;
                Utils.$('#completed-quiz').textContent = completedQuiz;
                Utils.$('#avg-score').textContent = avgScore + 'ç‚¹';
                Utils.$('#survey-completed').textContent = surveyCompleted;

            } catch (error) {
                console.error('çµ±è¨ˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚¯ã‚¤ãƒƒã‚¯ç·¨é›†ç”¨å•é¡Œèª­ã¿è¾¼ã¿
        async function loadQuickEditQuestions() {
            try {
                const result = await Utils.apiCall('/api/quiz/questions');
                const questions = result.questions || [];
                const container = Utils.$('#quick-edit-questions');

                const questionsHtml = questions.slice(0, 6).map(q => `
                    <div class="quick-edit-card">
                        <div class="question-preview">
                            <strong>å•é¡Œ${q.question_number}</strong>
                            <p>${q.question_text.substring(0, 50)}...</p>
                            <small>æ­£è§£: ${q.correct_answer}</small>
                        </div>
                        <div class="quick-actions">
                            <button onclick="quickEditQuestion(${q.id})" class="btn btn-outline btn-small">
                                âœï¸ ç·¨é›†
                            </button>
                            <button onclick="quickEditExplanation(${q.id})" class="btn btn-info btn-small">
                                ğŸ’¬ è§£èª¬
                            </button>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = questionsHtml;

            } catch (error) {
                console.error('ã‚¯ã‚¤ãƒƒã‚¯ç·¨é›†èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // å•é¡Œä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadQuestionsList() {
            try {
                const result = await Utils.apiCall('/api/quiz/questions');
                const questions = result.questions || [];
                const container = Utils.$('#questions-list');

                const questionsHtml = questions.map(q => `
                    <div class="question-item">
                        <div class="question-header">
                            <strong>å•é¡Œ ${q.question_number}: ${q.question_text}</strong>
                            <div>
                                <button onclick="editQuestion(${q.id})" class="btn btn-outline btn-small">ç·¨é›†</button>
                                <button onclick="deleteQuestion(${q.id})" class="btn btn-danger btn-small">å‰Šé™¤</button>
                            </div>
                        </div>
                        <div class="question-details">
                            <p><strong>é¸æŠè‚¢:</strong> A: ${q.choice_a} | B: ${q.choice_b} | C: ${q.choice_c} | D: ${q.choice_d}</p>
                            <p><strong>æ­£è§£:</strong> ${q.correct_answer}</p>
                            <p><strong>è§£èª¬:</strong> ${q.explanation}</p>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = questionsHtml;

            } catch (error) {
                console.error('å•é¡Œä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆèª­ã¿è¾¼ã¿
        async function loadSystemStats() {
            try {
                const container = Utils.$('#system-stats');
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div class="stat-item">
                            <h4>ğŸ• ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒæ™‚é–“</h4>
                            <p>èµ·å‹•æ™‚åˆ»: ${new Date().toLocaleString('ja-JP')}</p>
                        </div>
                        <div class="stat-item">
                            <h4>ğŸ“Š ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡</h4>
                            <p>ãƒ¡ãƒ¢ãƒªãƒ™ãƒ¼ã‚¹DBç¨¼åƒä¸­</p>
                        </div>
                        <div class="stat-item">
                            <h4>ğŸ”„ æ¥ç¶šçŠ¶æ³</h4>
                            <p>æœ€å¤§200ååŒæ™‚æ¥ç¶šå¯¾å¿œ</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¨­å®š
        function setupFormHandlers() {
            const newQuestionForm = Utils.$('#new-question-form');
            if (newQuestionForm) {
                newQuestionForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await addNewQuestion();
                });
            }

            const createUserForm = Utils.$('#create-user-form');
            if (createUserForm) {
                createUserForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await createNewUser();
                });
            }
        }

        // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
        async function createNewUser() {
            const userData = {
                real_name: Utils.$('#new-user-name').value,
                nickname: Utils.$('#new-user-nickname').value,
                age_group: Utils.$('#new-user-age').value,
                gender: Utils.$('#new-user-gender').value,
                password: Utils.$('#new-user-password').value
            };

            try {
                const result = await Utils.apiCall('/api/admin/users', {
                    method: 'POST',
                    body: JSON.stringify(userData)
                });

                if (result.success) {
                    Utils.showSuccess(`ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ: ${userData.nickname}`);
                    Utils.$('#create-user-form').reset();
                    await loadDashboardStats(); // çµ±è¨ˆã‚’æ›´æ–°
                }
            } catch (error) {
                Utils.showError('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // æ–°è¦å•é¡Œè¿½åŠ 
        async function addNewQuestion() {
            const questionData = {
                question_number: parseInt(Utils.$('#new-question-number').value),
                question_text: Utils.$('#new-question-text').value,
                choice_a: Utils.$('#new-choice-a').value,
                choice_b: Utils.$('#new-choice-b').value,
                choice_c: Utils.$('#new-choice-c').value,
                choice_d: Utils.$('#new-choice-d').value,
                correct_answer: Utils.$('#new-correct-answer').value,
                explanation: Utils.$('#new-explanation').value
            };

            try {
                const result = await Utils.apiCall('/api/admin/questions', {
                    method: 'POST',
                    body: JSON.stringify(questionData)
                });

                if (result.success) {
                    Utils.showSuccess('å•é¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                    Utils.$('#new-question-form').reset();
                    await loadQuestionsList();
                    await loadQuickEditQuestions();
                }
            } catch (error) {
                Utils.showError('å•é¡Œã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // CSVå‡ºåŠ›æ©Ÿèƒ½
        async function exportScoreData() {
            try {
                const response = await fetch('/api/admin/export/scores');
                if (response.ok) {
                    const blob = await response.blob();
                    downloadCSV(blob, 'quiz_scores.csv');
                } else {
                    Utils.showError('æˆç¸¾ãƒ‡ãƒ¼ã‚¿ã®å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                Utils.showError('æˆç¸¾ãƒ‡ãƒ¼ã‚¿ã®å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function exportSurveyData() {
            try {
                const response = await fetch('/api/admin/export/survey');
                if (response.ok) {
                    const blob = await response.blob();
                    downloadCSV(blob, 'survey_results.csv');
                } else {
                    Utils.showError('ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                Utils.showError('ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function exportQuestionAnalysis() {
            try {
                const response = await fetch('/api/admin/export/questions');
                if (response.ok) {
                    const blob = await response.blob();
                    downloadCSV(blob, 'question_analysis.csv');
                } else {
                    Utils.showError('å•é¡Œåˆ†æãƒ‡ãƒ¼ã‚¿ã®å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                Utils.showError('å•é¡Œåˆ†æãƒ‡ãƒ¼ã‚¿ã®å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function exportFullReport() {
            try {
                const response = await fetch('/api/admin/export/full');
                if (response.ok) {
                    const blob = await response.blob();
                    downloadCSV(blob, 'full_report.csv');
                } else {
                    Utils.showError('çµ±åˆãƒ¬ãƒãƒ¼ãƒˆã®å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                Utils.showError('çµ±åˆãƒ¬ãƒãƒ¼ãƒˆã®å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function downloadCSV(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            Utils.showSuccess(`${filename} ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`);
        }

        // ãã®ä»–ã®æ©Ÿèƒ½ï¼ˆç°¡ç•¥ç‰ˆï¼‰
        async function quickEditQuestion(questionId) {
            // ã‚¯ã‚¤ãƒƒã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆå®Ÿè£…çœç•¥ï¼‰
            Utils.showSuccess('ã‚¯ã‚¤ãƒƒã‚¯ç·¨é›†æ©Ÿèƒ½ï¼ˆå®Ÿè£…ä¸­ï¼‰');
        }

        async function quickEditExplanation(questionId) {
            // è§£èª¬ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆå®Ÿè£…çœç•¥ï¼‰
            Utils.showSuccess('è§£èª¬ç·¨é›†æ©Ÿèƒ½ï¼ˆå®Ÿè£…ä¸­ï¼‰');
        }

        async function editQuestion(questionId) {
            try {
                // å•é¡Œãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const result = await Utils.apiCall('/api/quiz/questions');
                const question = result.questions.find(q => q.id === questionId);
                
                if (!question) {
                    Utils.showError('å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
                showQuestionEditModal(question);
            } catch (error) {
                Utils.showError('å•é¡Œã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // å•é¡Œç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showQuestionEditModal(question) {
            const modalHtml = `
                <div id="edit-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                     background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; max-width: 600px; width: 90%; max-height: 90%; overflow-y: auto; 
                         border-radius: var(--border-radius); padding: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3>å•é¡Œç·¨é›† - å•é¡Œ${question.question_number}</h3>
                            <button onclick="closeEditModal()" style="border: none; background: none; font-size: 1.5rem; cursor: pointer;">Ã—</button>
                        </div>
                        
                        <form id="edit-question-form">
                            <div style="display: grid; gap: 1rem;">
                                <div>
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">å•é¡Œæ–‡</label>
                                    <textarea id="edit-question-text" style="width: 100%; min-height: 80px; padding: 0.5rem; 
                                              border: 1px solid var(--light-gray); border-radius: var(--border-radius);">${question.question_text}</textarea>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                                    <div>
                                        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">é¸æŠè‚¢A</label>
                                        <input type="text" id="edit-choice-a" value="${question.choice_a}" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--light-gray); border-radius: var(--border-radius);">
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">é¸æŠè‚¢B</label>
                                        <input type="text" id="edit-choice-b" value="${question.choice_b}" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--light-gray); border-radius: var(--border-radius);">
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">é¸æŠè‚¢C</label>
                                        <input type="text" id="edit-choice-c" value="${question.choice_c}" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--light-gray); border-radius: var(--border-radius);">
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">é¸æŠè‚¢D</label>
                                        <input type="text" id="edit-choice-d" value="${question.choice_d}" 
                                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--light-gray); border-radius: var(--border-radius);">
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">æ­£è§£</label>
                                    <select id="edit-correct-answer" style="width: 100%; padding: 0.5rem; border: 1px solid var(--light-gray); border-radius: var(--border-radius);">
                                        <option value="A" ${question.correct_answer === 'A' ? 'selected' : ''}>A</option>
                                        <option value="B" ${question.correct_answer === 'B' ? 'selected' : ''}>B</option>
                                        <option value="C" ${question.correct_answer === 'C' ? 'selected' : ''}>C</option>
                                        <option value="D" ${question.correct_answer === 'D' ? 'selected' : ''}>D</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">è§£èª¬</label>
                                    <textarea id="edit-explanation" style="width: 100%; min-height: 100px; padding: 0.5rem; 
                                              border: 1px solid var(--light-gray); border-radius: var(--border-radius);">${question.explanation}</textarea>
                                </div>
                                
                                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                                    <button type="button" onclick="closeEditModal()" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                                    <button type="submit" class="btn btn-success">ä¿å­˜</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('edit-question-form').addEventListener('submit', (e) => {
                e.preventDefault();
                saveQuestionEdit(question.id);
            });
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeEditModal() {
            const modal = document.getElementById('edit-modal');
            if (modal) {
                modal.remove();
            }
        }

        // å•é¡Œç·¨é›†ã‚’ä¿å­˜
        async function saveQuestionEdit(questionId) {
            const updatedData = {
                question_text: document.getElementById('edit-question-text').value,
                choice_a: document.getElementById('edit-choice-a').value,
                choice_b: document.getElementById('edit-choice-b').value,
                choice_c: document.getElementById('edit-choice-c').value,
                choice_d: document.getElementById('edit-choice-d').value,
                correct_answer: document.getElementById('edit-correct-answer').value,
                explanation: document.getElementById('edit-explanation').value
            };

            try {
                const result = await Utils.apiCall(`/api/admin/questions/${questionId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updatedData)
                });

                if (result.success) {
                    Utils.showSuccess('å•é¡Œã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    closeEditModal();
                    await loadQuestionsList(); // ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                    await loadQuickEditQuestions(); // ã‚¯ã‚¤ãƒƒã‚¯ç·¨é›†ã‚‚æ›´æ–°
                }
            } catch (error) {
                Utils.showError('å•é¡Œã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function deleteQuestion(questionId) {
            if (!confirm('ã“ã®å•é¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            try {
                const result = await Utils.apiCall(`/api/admin/questions/${questionId}`, {
                    method: 'DELETE'
                });

                if (result.success) {
                    Utils.showSuccess('å•é¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    await loadQuestionsList();
                    await loadQuickEditQuestions();
                }
            } catch (error) {
                Utils.showError('å•é¡Œã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
    </script>

    <!-- ç®¡ç†ç”»é¢ç”¨è¿½åŠ CSS -->
    <style>
        .priority-section {
            margin-bottom: 3rem;
        }

        .detailed-section {
            margin-top: 2rem;
        }

        .stats-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            text-align: center;
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stats-label {
            font-size: var(--font-size-sm);
            opacity: 0.9;
        }

        .quick-edit-card {
            background: var(--light-gray);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .quick-edit-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .question-preview p {
            color: var(--gray);
            margin: 0.5rem 0;
        }

        .quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .export-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            border: 2px solid var(--light-gray);
            text-align: center;
            transition: all 0.3s ease;
        }

        .export-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .export-card h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .export-card p {
            color: var(--gray);
            margin-bottom: 1rem;
            font-size: var(--font-size-sm);
        }

        .question-item {
            background: var(--white);
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--light-gray);
            border-bottom: 1px solid var(--border-color);
        }

        .question-details {
            padding: 1rem;
        }

        .question-details p {
            margin-bottom: 0.5rem;
            font-size: var(--font-size-sm);
        }

        .admin-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--light-gray);
            border-radius: var(--border-radius);
        }

        .stat-item {
            background: var(--white);
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--light-gray);
        }

        .stat-item h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .alert {
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
        }

        .alert-error {
            background: rgba(220, 20, 60, 0.1);
            color: var(--error);
            border: 1px solid var(--error);
        }

        .alert-success {
            background: rgba(34, 139, 34, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        @media (max-width: 768px) {
            .quick-actions {
                flex-direction: column;
            }
            
            .question-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }
    </style>
</body>
</html>