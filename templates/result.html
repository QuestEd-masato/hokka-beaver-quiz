<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¦« hokkaã‚¯ã‚¤ã‚ºãƒ©ãƒªãƒ¼ - çµæœç™ºè¡¨</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 style="display: flex; align-items: center;">
                    <img src="/images/beaver-logo.png" alt="ãƒ“ãƒ¼ãƒãƒ¼ãƒ­ã‚´" style="height: 50px; margin-right: 15px;">
                    hokkaã‚¯ã‚¤ã‚ºãƒ©ãƒªãƒ¼
                </h1>
                <button onclick="Auth.logout()" class="btn btn-secondary btn-small">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main">
        <div class="container">
            <!-- çµæœç™ºè¡¨ -->
            <div class="card text-center fade-in">
                <div class="card-header">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <img src="/images/beaver.png" alt="ãƒ“ãƒ¼ãƒãƒ¼ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼" style="height: 100px; animation: bounce 1s ease-in-out infinite;">
                        <h2>ğŸ‰ ã‚¯ã‚¤ã‚ºå®Œäº†ï¼ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼</h2>
                    </div>
                </div>
                <div class="card-body">
                    <!-- ã‚¹ã‚³ã‚¢è¡¨ç¤º -->
                    <div class="score-display" style="margin: 2rem 0;">
                        <div class="final-score" style="font-size: 4rem; font-weight: 700; color: var(--primary); margin-bottom: 1rem;">
                            <span id="final-score">0</span><span style="font-size: 2rem;">ç‚¹</span>
                        </div>
                        <div class="correct-count" style="font-size: 1.5rem; color: var(--gray); margin-bottom: 2rem;">
                            <span id="correct-count">0</span> / 10 å•æ­£è§£
                        </div>
                        
                        <!-- æˆç¸¾è©•ä¾¡ -->
                        <div id="grade-evaluation" class="grade-evaluation" style="padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 2rem;">
                            <!-- JavaScriptã§å‹•çš„ã«è¨­å®š -->
                        </div>
                    </div>

                    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                    <div class="action-buttons">
                        <a href="/mypage" class="btn btn-secondary btn-large">
                            ğŸ  ãƒã‚¤ãƒšãƒ¼ã‚¸
                        </a>
                        <a href="/survey" class="btn btn-success btn-large">
                            ğŸ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã§ãƒœãƒ¼ãƒŠã‚¹GET
                        </a>
                        <a href="/ranking" class="btn btn-primary btn-large">
                            ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹
                        </a>
                    </div>
                </div>
            </div>

            <!-- è©³ç´°çµæœ -->
            <div class="card slide-in" style="animation-delay: 0.3s;">
                <div class="card-header">
                    <h3>ğŸ“Š è©³ç´°çµæœ</h3>
                </div>
                <div class="card-body">
                    <div id="detailed-results">
                        <!-- è©³ç´°çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        <div class="text-center" style="padding: 20px; color: var(--gray);">
                            çµæœã‚’èª­ã¿è¾¼ã¿ä¸­...
                        </div>
                    </div>
                </div>
            </div>

            <!-- å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ -->
            <div class="card slide-in" style="animation-delay: 0.6s;">
                <div class="card-header">
                    <h3>ğŸ’¡ ä»Šå›å­¦ã‚“ã ã“ã¨</h3>
                </div>
                <div class="card-body">
                    <div class="learning-points">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <div class="learning-item">
                                <h4 style="color: var(--primary); margin-bottom: 0.5rem;">ğŸ­ åŒ—é™¸è£½è“ã«ã¤ã„ã¦</h4>
                                <ul style="line-height: 1.8;">
                                    <li>å¤§æ­£7å¹´ï¼ˆ1918å¹´ï¼‰å‰µç«‹ã®è€èˆ—ä¼æ¥­</li>
                                    <li>100å¹´ä»¥ä¸Šã®æ­´å²ã‚’æŒã¤é‡‘æ²¢ã®ä¼æ¥­</li>
                                    <li>3ãƒ¶æœˆã«1å›æ–°å•†å“é–‹ç™ºã‚’ç›®æ¨™</li>
                                </ul>
                            </div>
                            <div class="learning-item">
                                <h4 style="color: var(--secondary); margin-bottom: 0.5rem;">ğŸ˜ ãƒ“ãƒ¼ãƒãƒ¼è£½å“ã«ã¤ã„ã¦</h4>
                                <ul style="line-height: 1.8;">
                                    <li>åŒ—é™¸ç”£ã‚‚ã¡ç±³100%ä½¿ç”¨</li>
                                    <li>æ—¥é«˜æ˜†å¸ƒã¨é³´é–€ã®ç„¼å¡©ã‚’ä½¿ç”¨</li>
                                    <li>æ˜”ã‹ã‚‰ã®ç‰¹åˆ¥ãªãƒ¬ã‚·ãƒ”</li>
                                </ul>
                            </div>
                            <div class="learning-item">
                                <h4 style="color: var(--accent); margin-bottom: 0.5rem;">ğŸŒ åœ°åŸŸè²¢çŒ®ãƒ»ç’°å¢ƒæ´»å‹•</h4>
                                <ul style="line-height: 1.8;">
                                    <li>ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«å¿œæ´ãƒ»ä¿è‚²åœ’æ”¯æ´</li>
                                    <li>ç’°å¢ƒã«ã‚„ã•ã—ã„å¤§è±†ã‚¤ãƒ³ã‚¯ä½¿ç”¨</li>
                                    <li>åŒ—é™¸ã®ã‚½ã‚¦ãƒ«ãƒ•ãƒ¼ãƒ‰ã‚’ç›®æŒ‡ã™</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— -->
            <div class="card slide-in text-center" style="animation-delay: 0.9s;">
                <div class="card-body">
                    <h3 style="margin-bottom: 1rem;">ğŸš€ æ¬¡ã¯ä½•ã‚’ã—ã¾ã™ã‹ï¼Ÿ</h3>
                    <p style="margin-bottom: 2rem; color: var(--gray);">
                        ã‚¯ã‚¤ã‚ºã¯ã“ã‚Œã§çµ‚äº†ã§ã™ãŒã€ã¾ã ã¾ã æ¥½ã—ã„ã“ã¨ãŒå¾…ã£ã¦ã„ã¾ã™ï¼
                    </p>
                    <div class="action-buttons" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                        <div class="next-step-item" style="padding: 1.5rem; background: var(--light-gray); border-radius: var(--border-radius);">
                            <h4 style="color: var(--secondary); margin-bottom: 1rem;">ğŸ  ãƒã‚¤ãƒšãƒ¼ã‚¸</h4>
                            <p style="margin-bottom: 1rem;">å€‹äººæˆç¸¾ã‚„è©³ç´°ãªçµæœã‚’ç¢ºèªã—ã‚ˆã†ï¼</p>
                            <a href="/mypage" class="btn btn-secondary">ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’è¦‹ã‚‹</a>
                        </div>
                        <div class="next-step-item" style="padding: 1.5rem; background: var(--light-gray); border-radius: var(--border-radius);">
                            <h4 style="color: var(--success); margin-bottom: 1rem;">ğŸ“ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h4>
                            <p style="margin-bottom: 1rem;">æ„Ÿæƒ³ã‚’æ•™ãˆã¦ãƒœãƒ¼ãƒŠã‚¹ãƒã‚¤ãƒ³ãƒˆã‚’GETï¼</p>
                            <a href="/survey" class="btn btn-success">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«ç­”ãˆã‚‹</a>
                        </div>
                        <div class="next-step-item" style="padding: 1.5rem; background: var(--light-gray); border-radius: var(--border-radius);">
                            <h4 style="color: var(--primary); margin-bottom: 1rem;">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h4>
                            <p style="margin-bottom: 1rem;">ä»–ã®å‚åŠ è€…ã¨æˆç¸¾ã‚’æ¯”è¼ƒã—ã¦ã¿ã‚ˆã†ï¼</p>
                            <a href="/ranking" class="btn btn-primary">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¦‹ã‚‹</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 é‡‘æ²¢å­¦é™¢å¤§å­¦é™„å±ä¸­å­¦æ ¡ï¼’å¹´ï¼‘çµ„ - hokkaã‚¯ã‚¤ã‚ºãƒ©ãƒªãƒ¼</p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="/js/app.js"></script>

    <!-- çµæœãƒšãƒ¼ã‚¸å›ºæœ‰ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // çµæœãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆé€šå¸¸ã¯ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã€ä»Šå›ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ï¼‰
            displayResults();
            displayDetailedResults();
        });

        // çµæœè¡¨ç¤º
        async function displayResults() {
            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰çµæœã‚’å–å¾—
            const currentUser = Auth.getCurrentUser();
            if (!currentUser || !currentUser.id) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“');
                return;
            }
            
            let quizResult;
            try {
                const statusResult = await Utils.apiCall(`/api/quiz/status/${currentUser.id}`);
                quizResult = {
                    score: statusResult.score || 0,
                    correctCount: statusResult.correctCount || 0,
                    totalQuestions: statusResult.totalQuestions || 10
                };
            } catch (error) {
                console.error('çµæœå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
                quizResult = {
                    score: 0,
                    correctCount: 0,
                    totalQuestions: 10
                };
            }

            // ã‚¹ã‚³ã‚¢è¡¨ç¤º
            const finalScoreElement = Utils.$('#final-score');
            const correctCountElement = Utils.$('#correct-count');
            
            if (finalScoreElement) {
                finalScoreElement.textContent = quizResult.score;
            }
            
            if (correctCountElement) {
                correctCountElement.textContent = quizResult.correctCount;
            }

            // æˆç¸¾è©•ä¾¡è¡¨ç¤º
            displayGradeEvaluation(quizResult.score, quizResult.correctCount);
        }

        // æˆç¸¾è©•ä¾¡è¡¨ç¤º
        function displayGradeEvaluation(score, correctCount) {
            const gradeElement = Utils.$('#grade-evaluation');
            if (!gradeElement) return;

            let grade, message, bgColor, textColor;

            if (correctCount >= 9) {
                grade = "ğŸ† ãƒ“ãƒ¼ãƒãƒ¼åšå£«";
                message = "ç´ æ™´ã‚‰ã—ã„ï¼ãƒ“ãƒ¼ãƒãƒ¼ã¨ãŠã‹ãã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ã™ï¼";
                bgColor = "linear-gradient(135deg, #ffd700 0%, #ffed4e 100%)";
                textColor = "#333";
            } else if (correctCount >= 7) {
                grade = "ğŸ¥‡ ãƒ“ãƒ¼ãƒãƒ¼ä¸Šç´šè€…";
                message = "ã™ã”ã„ï¼ãƒ“ãƒ¼ãƒãƒ¼ã¨ãŠã‹ãã«ã¤ã„ã¦ã‚ˆãçŸ¥ã£ã¦ã„ã¾ã™ã­ï¼";
                bgColor = "linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%)";
                textColor = "#333";
            } else if (correctCount >= 5) {
                grade = "ğŸ¥‰ ãƒ“ãƒ¼ãƒãƒ¼ä¸­ç´šè€…";
                message = "è‰¯ã„æ„Ÿã˜ï¼ã‚‚ã†å°‘ã—å­¦ã¹ã°ãƒ“ãƒ¼ãƒãƒ¼åšå£«ã«ãªã‚Œãã†ã§ã™ï¼";
                bgColor = "linear-gradient(135deg, #cd7f32 0%, #daa520 100%)";
                textColor = "#fff";
            } else {
                grade = "ğŸ“š ãƒ“ãƒ¼ãƒãƒ¼åˆå¿ƒè€…";
                message = "ä»Šå›ã¯ç·´ç¿’ï¼ãƒ“ãƒ¼ãƒãƒ¼ã¨ãŠã‹ãã«ã¤ã„ã¦ã‚‚ã£ã¨å­¦ã‚“ã§ã¿ã¾ã—ã‚‡ã†ï¼";
                bgColor = "linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%)";
                textColor = "#fff";
            }

            gradeElement.innerHTML = `
                <div style="background: ${bgColor}; color: ${textColor}; padding: 1.5rem; border-radius: var(--border-radius);">
                    <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem;">${grade}</h3>
                    <p style="margin: 0; font-size: 1.1rem;">${message}</p>
                </div>
            `;
        }

        // è©³ç´°çµæœè¡¨ç¤º
        async function displayDetailedResults() {
            const detailedContainer = Utils.$('#detailed-results');
            if (!detailedContainer) return;

            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
            const currentUser = Auth.getCurrentUser();
            if (!currentUser || !currentUser.id) {
                detailedContainer.innerHTML = '<div class="text-center" style="padding: 20px; color: var(--error);">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“</div>';
                return;
            }

            try {
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è©³ç´°çµæœã‚’å–å¾—
                const response = await fetch(`/api/quiz/results/${currentUser.id}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                let detailedHtml = '<div style="display: grid; gap: 1rem;">';
                
                data.results.forEach(result => {
                    const userAnswer = result.userAnswer || 'æœªå›ç­”';
                    const correctAnswer = result.correctAnswer;
                    const isCorrect = result.isCorrect;
                    const statusIcon = isCorrect ? 'âœ…' : 'âŒ';
                    const statusClass = isCorrect ? 'correct' : 'incorrect';
                    
                    detailedHtml += `
                        <div class="result-item ${statusClass}" style="
                            display: flex; 
                            align-items: center; 
                            padding: 1rem; 
                            background: ${isCorrect ? 'rgba(34, 139, 34, 0.1)' : 'rgba(220, 20, 60, 0.1)'}; 
                            border-radius: var(--border-radius);
                            border-left: 4px solid ${isCorrect ? 'var(--success)' : 'var(--error)'};
                        ">
                            <div style="font-size: 1.5rem; margin-right: 1rem;">${statusIcon}</div>
                            <div style="flex: 1;">
                                <strong>å•é¡Œ ${result.questionNumber}</strong><br>
                                <div style="font-size: 0.9rem; color: var(--gray); margin: 0.5rem 0;">
                                    ${result.questionText}
                                </div>
                                ã‚ãªãŸã®è§£ç­”: <span style="font-weight: 600;">${userAnswer}</span> | 
                                æ­£è§£: <span style="font-weight: 600; color: var(--success);">${correctAnswer}</span>
                                ${result.explanation ? `<div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--gray);">ğŸ’¡ ${result.explanation}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                detailedHtml += '</div>';
                detailedContainer.innerHTML = detailedHtml;
            } catch (error) {
                console.error('è©³ç´°çµæœå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                detailedContainer.innerHTML = '<div class="text-center" style="padding: 20px; color: var(--error);">è©³ç´°çµæœã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }
    </script>
</body>
</html>